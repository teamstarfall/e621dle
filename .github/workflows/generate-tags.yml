name: Generate and Commit Tags

on:
    workflow_dispatch:
    schedule:
        - cron: "45 23 * * 0"
    push:
        branches:
            - "dev"
        paths:
            - "**"
            - "scripts/generate-tags.js"

jobs:
    generate-tags:
        if: github.actor != 'github-actions[bot]'
        runs-on: ubuntu-latest

        permissions:
            contents: write

        steps:
            - name: Checkout triggering branch
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Run tag generation script
              run: npm run generate-tags

            - name: Push /resources folder to data branch
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  # prepare a worktree for the data branch
                  git fetch origin data || true
                  git worktree add data-branch data || git worktree add data-branch -b data origin/dev

                  # copy resources into the data branch
                  mkdir -p data-branch/resources
                  cp -r resources/* data-branch/resources/

                  cd data-branch
                  git add resources
                  if git diff --cached --quiet; then
                    echo "No changes to commit."
                  else
                    git commit -m "chore(data): update generated tags from $GITHUB_REF"
                    git push origin data
                  fi
